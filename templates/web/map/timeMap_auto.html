<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>日历形式显示</title>
    <link href="../../static/css/dateSlider.css" type="text/css" rel="stylesheet" />
    <script language="javascript" src="../../static/js/jquery.js"></script>
    <script language="javascript" src="../../static/js/jquery.ui.js"></script>
    <script language="javascript" src="../../static/js/DateSlider.js"></script>
    <script language="javascript" src="../../static/js/timeseries1-3.js"></script>
    <link src="../../static/css/d3.parcoords.css" type="text/css" rel="stylesheet" />
    <script language="javascript" src="../../static/js/DataTools.js"></script>
    <link href="../../static/css/timeseriesStyle.css" type="text/css" rel="stylesheet" />
    <link href="../../static/css/mainStyle.css" type="text/css" rel="stylesheet" /> </head>
<style>
    .nar-all {
        width: 100%;
        height: 250px;
    }
    
    #executerDiv {
        height: 16px;
    }
    
    #executerDiv ul {
        margin: 0px;
        padding: 0px;
        list-style-type: none;
        vertical-align: middle;
    }
    
    #executerDiv li {
        float: left;
        display: block;
        width: 30px;
        height: 20px;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        color: #666666;
        text-decoration: none;
        text-align: left;
        background: #ffffff;
    }
    
    div .argment_set {
        width: 100%;
        height: 210px;
        margin: 0px 0px 10px 20px;
        position: absolute;
    }
    
    div #mode_set,
    #segment_set,
    #filter,
    #draw_set {
        width: 22.5%;
        height: 210px;
        float: left;
        /*        margin: 10px 0px 10px 0px;*/
        border: 1px solid #B6B6B6;
        /**边框**/
        border-top: 0;
        padding-left: 15px;
        padding-top: 0px;
        /**内边距**/
    }
</style>
<style>
    /**导航ul-li**/
    
    .nav-warp {
        width: 100%;
        height: 40px;
        /*        margin: 10px 0px 0px 0px;*/
        border: 1px solid #B6B6B6;
        background-color: #19A97B;
    }
    
    .ui-nav {
        background-color: #19A97B;
    }
    
    .main-nav {
        float: left;
        list-style: none;
        -webkit-padding-start: 20px;
    }
    
    .ui-nav li {
        float: left;
        height: 30px;
        line-height: 30px;
        position: relative;
    }
    
    .ui-nav ul.main-nav a {
        display: inline-block;
        font-size: 16px;
        width: 118px;
        text-align: center;
        border-left: 1px solid #139667;
        position: relative;
        z-index: 1;
        color: #FFF!important;
        text-decoration: none;
    }
    
    #nav-map a {
        border-right: 1px solid #139667;
    }
    
    .ui-nav a {
        font-family: '\5FAE\8F6F\96C5\9ED1';
        /*    color: #FFF;*/
    }
</style>

<body>
    <div id="main">
        <div class="nar-all">
            <div class="nav-warp">
                <div class="ui-nav">
                    <ul class="main-nav">
                        <li id="nav-seg"><a href="#">工况分割设置</a></li>
                        <li id="nav-arg" style="margin-left: 235px;"><a href="#">参数分割设置</a></li>
                        <li id="nav-map" style="margin-left: 235px;"><a href="#">视图设置</a></li>
                        <li id="nav-div" style="margin-left: 235px;"><a href="#">视图选择</a></li>
                    </ul>
                </div>
            </div>
            <div class="argment_set">
                <div id="mode_set">
                    <p><strong>工况划分参数设置 </strong></p>
                    <p>
                        MW: min: <strong id="mwMinSet">900</strong>&nbsp; &nbsp; <input id="mwMinRange" type="range" min="500" max="900" step="100" value="900"></p>
                    <p> &nbsp; &nbsp; &nbsp; &nbsp;max: <strong id="mwMaxSet">1000</strong>&nbsp; &nbsp; <input id="mwMaxRange" type="range" min="600" max="1000" step="100" value="1000">
                    </p>
                    <p id="executerDiv"></p>
                    <p>循环水温：<input type="checkbox" value='3' name="water_set" selected="selected" id="3" />低<input name="water_set" type="checkbox" value='2' id="2" />中<input type="checkbox" value='1' id="1" name="water_set" />高<input id="cycleWaterSet" type="checkbox" name="cycleWaterSet" onclick="water_selectAll()" /> 全选/取消
                    </p>
                    <input type="button" id="mode_sure" name="mode_sure" onclick="get_allMode();" value="segment" style="margin-left:50%">
                    <!--            </form>-->
                </div>
                <div id="segment_set" style="border-left:0">
                    <p><strong>参数分割设置</strong></p>
                    <div id="arg_main">
                        <p> <input type="checkbox" name="arg_set" id="MW" />发电功率<input type="checkbox" name="arg_set" id="THRTEMP" />主蒸汽温度
                            <input type="checkbox" name="arg_set" id="MSP" />主蒸汽压力<input type="checkbox" name="arg_set" id="PAB10CT101" />循环水温度
                        </p>
                        <p><input type="checkbox" name="arg_set" id="flow" />循环水流量
                            <input type="checkbox" name="arg_set" id="YRHRTEMPT" />一次再热汽温
                            <input type="checkbox" name="arg_set" id="YRHRPRS" />一次再热汽压
                        </p>
                        <p><input type="checkbox" name="arg_set" id="RRHRTEMPT" />二次再热汽温
                            <input type="checkbox" name="arg_set" id="RRHRPRS" />二次再热汽压 &nbsp;&nbsp;
                            <input type="checkbox" name="arg_selectAll" id="arg_selectAll" onclick="arg_DOCheck()" />全选/取消</p>
                        <p>
                            <input type="radio" name="seg_edit" value="add stroke" onclick="add_segRect(2)" />add stroke

                            <input type="radio" name="seg_edit" value="add rect" onclick="add_segRect(1)" />add rect

                            <input type="radio" name="seg_edit" value="clear stroke" onclick="add_segRect(0)" />clear stroke
                        </p>
                        <p><input type="button" id="arg_seg" name="arg_seg" onclick="arg_segSure()" value="segment" style="margin-left:50%;margin-top:11px" /></p>
                    </div>
                </div>
                <div id="filter" style="border-left:0">
                    <p> <strong>pixle set:</strong></p>
                    <p>
                        <input type="text" name="pixleSize" id="pixleSize" value="3" style="width:30px" /> &nbsp;&nbsp;&nbsp; width：
                        <input type="text" name="pixleHeight" id="pixleHeight" value="10" style="width:30px" /> &nbsp;&nbsp;&nbsp; hight：
                        <input type='text' name="strokeSize" id="strokeSize" value="0" style="width:30px" /> &nbsp;&nbsp;&nbsp;
                        <select id="selectMap" class="selectMap" onchange="reload()">
				</select> &nbsp;&nbsp;&nbsp;
                        <input type="button" id="submit" name="submit" onclick="reload()" value="sure" />
                        <!--				<input type="button" id="brush_clear" name="brush_clear" onclick="brush_clear();" value="清空刷子" /> </p>-->
                    </p>
                    <p>resample: interval
                        <select id="interval" class="interval" onchange="reload();">
					<option value="1" selected="selected">1min</option>
					<option value="5" >5min</option>
                    <option value="10" >10min</option>
                    <option value="30" >30min</option>
                    <option value="60" >1h</option>
                    <option value="120" >2h</option>
				</select> &nbsp;&nbsp;&nbsp;
                        <select id="stat_obj" class="stat_obj" onchange="reload();">
                    <option value="">选择采样统计方式</option>
					<option value="mean">均值</option>
					<option value="std" >平均方差</option>
				</select> &nbsp;&nbsp;&nbsp;</p>
                    <p><input type="radio" name="stroke_edit" value="add stroke" onclick="add_stroke(1)" />add stroke
                        <input type="radio" name="stroke_edit" value="add rect" onclick="add_stroke(2)" />add rect
                        <input type="radio" name="stroke_edit" value="uniform stroke" onclick="add_stroke(3)" />uniform stroke
                        <input type="radio" name="stroke_edit" value="uniform capcity" onclick="add_stroke(4)" />uniform capcity
                        <input type="radio" name="stroke_edit" value="clear stroke" onclick="add_stroke(0)" />clear stroke
                    </p>
                </div>
                <div id="draw_set" style="border-left:0;width:21%">
                    <p><input type="radio" name="draw_select" onclick="draw_select(0)" />原始热力图
                        <input type="radio" name="draw_select" onclick="draw_select(1)" />工况划分图
                        <input type="radio" name="draw_select" onclick="draw_select(2)" />参数划分图</p>
                </div>
            </div>
        </div>
        <hr style="position:absolute;" />
        <!--        <div class="dateSlider" id="dateSlider" style="width:900px;margin:40px 20px"> </div>-->
        <div id="calendar-11" style="width:100%;height=420px;margin:10px 5px 10px 20px">
            <div id="calendar" style="width:80.5%;height:420px;float:left;border:1px solid #B6B6B6"></div>
            <div id="content_2" style="width:12.3%;height:420px;float:left;padding-left:10px;border:1px solid #B6B6B6">
                <p id='map_date'>时间</p>
            </div>
        </div>
            <div id="line_div" style="width:960px;height:270px;margin:20px 20px">
                <div id="timeseries_0_1" style="width:460px;height:200px;float:left"></div>
                <div id="timeseries_0_2" style="width:460px;height:200px; margin:10 10 0 0;float:left"></div>
            </div>
<!--            <hr/>-->
<!--
            <div id="layout_change" style="width:960px;margin:20px 20px"> </div>
            <div id="layout_show"> </div>
-->
            <div id="parallel_div" style="margin:10px 20px;width:100%">
                <p><label id="cod_detail"></label></p>
                <iframe id="iframe" frameBorder="0" width="100%" scrolling="yes" src="" height="1000"></iframe></div>
        </div>

        <footer></footer>
        <script src="../../static/D3/d3.v3.min.js"></script>
        <script>
            //        定义全局变量
            var temp_date = {{select_date | tojson}};
            var draw_flag = 0;
            var temp_1, temp_2;
            var coalDatas = [
                [500, [3, 4]],
                [600, [3, 4]],
                [700, [3, 4, 5]],
                [800, [4, 5]],
                [900, [5]]
            ];
            var seg_coal = "",
                seg_water = "",
                seg_arg = ""; //定义磨煤机选取，参数分割选取结果
            var cord_f, cord_s; //detail 截取时间
            var drawflag = 0,
                firstIndex, secondIndex, selectMap = '',
                interval = 1,
                stat_obj = '';
            var cellSize = 3,
                rawCell = 0,
                multiCell = 0,
                cellheight = 10,
                strokeSize = 0;
            var dir = "data/";
            var fileName = "../../static/data/raw/mpt2016030" + interval + "new.csv";
            //init();
            //转换日期格式
            var format = d3.time.format("%Y-%m-%d %H:%M:%S"),
                parseDate = d3.time.format("%Y-%m-%d %H:%M:%S");
            var Months = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            var Hours = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
            var firstDate, endDate, selectS, selectE;
            //原始数据颜色插值函数
            //        var a = d3.rgb(0, 255, 0); //绿色
            //        var b = d3.rgb(255, 0, 0); //红色
            //        var c = d3.rgb(255, 97, 0); //橙色
            var a = "#ffffcc",
                b = "#800026";
            var compute = d3.interpolateHsl(a, b);
            //var compute = d3.interpolateHsl(b, c);
            var color = d3.scale.linear().range([0, 1]);
            var mode_class;

            //第一次过滤后工况映射颜色
            var buckets = 6; // 一共6种颜色级别
            var seg_color_1 = ["#00441b", "#4d004b",
                    "#807dba", "#084081", "#969696", "#b15928"
                ],
                colorScale;

            //数据存储单元
            var json_data, csv_nest, csv_data, num, csv_range, sumNum, seg_data, type_flag, seg_nest; //各变量量程
            loadAll();
            var brush_obj, line_obj, brush_foreground, line_brush_selection;
            var line_brush_num = 0;

            function init() {
                cellSize = document.getElementById("pixleSize").value; // cell size
                cellheight = $("#pixleHeight").val();
                strokeSize = $("#strokeSize").val();
                var obj_selectMap = document.getElementById("selectMap");
                selectMap  =  obj_selectMap.options[obj_selectMap.options.selectedIndex].value;  //这是取值 
                //时间间隔
                var obj_interval = document.getElementById("interval");
                interval  =  obj_interval.options[obj_interval.options.selectedIndex].value;
                fileName = "../../static/data/raw/mpt2016030" + interval + ".csv";
                var obj_stat = document.getElementById("stat_obj");
                stat_obj = obj_stat.options[obj_stat.options.selectedIndex].value;
            }
            init_coal();
            //        var json_obj, json_data;
            d3.select("#mwMinRange").on("change", function() {
                //            console.log(this.value);
                d3.select("#mwMinSet").text(this.value);
                init_coal();
            });
            d3.select("#mwMaxRange").on("change", function() {
                //            console.log(this.value);
                d3.select("#mwMaxSet").text(this.value);
                init_coal();
            });
            if (temp_date != "") {
                init_map();
            }

            function init_map() {
                var heatmap_path = '../../static/data/raw/interval-10min/rawData' + temp_date['flag_y'] + '.' + temp_date['flag_m'] + '.01.csv';
                d3.csv(heatmap_path, function(error, csv) {
                    //数据类型转换
                    csv.forEach(function(d, i) {
                        d.index = i;
                        d.keyDate = d.date;
                        d.MW = parseInt(d.MW);
                        d.MWD2 = parseInt(d.MWD2);
                        d.NOW = parseInt(d.NOW);
                        d.BMOUT = parseInt(d.BMOUT);
                        d.HNA00AA001AXQ01 = parseInt(d.HNA00AA001AXQ01);
                        d.HNA00AA001BXQ01 = parseInt(d.HNA00AA001BXQ01);
                        d.HNA00AA002AXQ01 = parseInt(d.HNA00AA002AXQ01);
                        d.HNA00AA002BXQ01 = parseInt(d.HNA00AA002BXQ01);
                        d.date = parseDate.parse(d.date);
                        d.day = d.date.getDate();
                        d.minute = d.date.getMinutes();
                    });
                    //                console.log(csv);
                    //热力图时间范围
                    //                var heatmaprange = d3.extent(csv, function(d) {
                    //                    return d.date;
                    //                })
                    //                document.getElementById("heatmaprange").innerHTML = "时间范围：" +convertDate(heatmaprange[0]) + " 至 " + convertDate(heatmaprange[1]);


                    //每个时间对应一个参数值
                    csv_nest = d3.nest().key(function(d) {
                            return d.day;
                        })
                        .entries(csv);
                    draw_flag = 0;
                    csv_data = csv;
                    //将mwdata进行分组，分成各个月份进行绘制
                    draw_org();

                })


            }

            function init_coal() {
                var executerDiv = document.getElementById("executerDiv");   
                var MWMin = document.getElementById("mwMinSet").textContent;
                var MWMax = document.getElementById("mwMaxSet").textContent;
                //    alert(MWMin);
                executerDiv.innerHTML = "<label style='float:left'>磨煤机台数：</label>";   
                var ul = document.createElement("ul");   
                ul.setAttribute('style', 'float:left');
                for (var k in coalDatas) {
                    var val = coalDatas[k][0];
                    if (val == MWMin) {
                        var flag = 0;
                        if (MWMin < 700 && MWMax > 700) {
                            flag++;
                            coalDatas[k][1].push(5);
                        }
                        for (var i = 0; i < coalDatas[k][1].length; i++) {   
                            var arr = coalDatas[k][1][i];       
                            // 加入复选框               
                            var checkBox = document.createElement("input");       
                            checkBox.setAttribute("type", "checkbox");  
                            checkBox.setAttribute("id", arr);       
                            checkBox.setAttribute("name", "coalbox");       
                            var li = document.createElement("li");       
                            li.appendChild(checkBox);              
                            li.appendChild(document.createTextNode(arr));       
                            ul.appendChild(li);          
                        }   
                        executerDiv.appendChild(ul);  
                        var checkBox = document.createElement("input");       
                        checkBox.setAttribute("type", "checkbox");       
                        checkBox.setAttribute("id", 'allChecked');       
                        checkBox.setAttribute("name", "allChecked");
                        checkBox.setAttribute("value", '全选/取消');
                        checkBox.onclick = DoCheck;
                        //            checkBox.addEventListener("onclick", "DoCheck()");
                        var li = document.createElement("li");    
                        li.setAttribute("style", 'width:100px;');
                        li.appendChild(checkBox);              
                        li.appendChild(document.createTextNode('全选/取消'));       
                        ul.appendChild(li);   
                        executerDiv.appendChild(ul);
                        if (flag > 0)
                            coalDatas[k][1].pop(5);
                    }
                }

                function DoCheck() {
                    var ch = document.getElementsByName("coalbox");
                    if (document.getElementsByName("allChecked")[0].checked == true) {
                        for (var i = 0; i < ch.length; i++) {
                            ch[i].checked = true;
                        }
                    } else {
                        for (var i = 0; i < ch.length; i++) {
                            ch[i].checked = false;
                        }
                    }
                }
            }

            //参数分割全选/取消功能
            function arg_DOCheck() {
                var ch = document.getElementsByName("arg_set");
                if (document.getElementsByName("arg_selectAll")[0].checked == true) {
                    for (var i = 0; i < ch.length; i++) {
                        //                    console.log(ch[i].id);
                        ch[i].checked = true;
                    }
                } else {
                    for (var i = 0; i < ch.length; i++) {
                        ch[i].checked = false;
                    }
                }
            }
            //循环水温全选/取消设置
            function water_selectAll() {
                var ch = document.getElementsByName("water_set");
                if (document.getElementsByName("cycleWaterSet")[0].checked == true) {
                    for (var i = 0; i < ch.length; i++) {
                        //                    console.log(ch[i].id);
                        ch[i].checked = true;
                    }
                } else {
                    for (var i = 0; i < ch.length; i++) {
                        ch[i].checked = false;
                    }
                }
            }
            //第一次分割
            function get_allMode() {
                seg_water = "", seg_coal = "";
                //获取磨煤机台数
                var ch = document.getElementsByName("coalbox");
                for (var i = 0; i < ch.length; i++) {
                    if (ch[i].checked) {
                        seg_coal += ch[i].id + ",";
                    }
                }
                seg_coal = seg_coal.slice(0, -1);
                //获取循环水温
                var ch = document.getElementsByName("water_set");
                for (var i = 0; i < ch.length; i++) {
                    if (ch[i].checked) {
                        seg_water += ch[i].id + ",";
                    }
                }
                seg_water = seg_water.slice(0, -1);

                var data = []
                data.push(d3.select("#mwMinSet").text());
                data.push(d3.select('#mwMaxSet').text());
                data.push(seg_coal);
                data.push(seg_water); //循环水取值
                //            console.log(data);
                $.ajax({
                    url: '/get_allMode',
                    type: 'GET',
                    data: {
                        min: data[0],
                        max: data[1],
                        coal: data[2],
                        water: data[3],
                        flag_y: temp_date['flag_y'],
                        flag_m: temp_date['flag_m']
                    },
                    success: function(arg) {
                        var data_obj = jQuery.parseJSON(arg[0]);
                        type_flag = arg[1];
                        mode_class = arg[2];
                        var select_obj = d3.select('#selectMap');
                        if (type_flag < 0) {
                            alert("没有满足条件的工况段!")
                        } else {
                            var index = 0;
                            sumNum = [];
                            for (var i in data_obj) {
                                data_obj[i].index = index;
                                data_obj[i][selectMap] = parseInt(+data_obj[i][selectMap]);
                                data_obj[i].keyDate = data_obj[i].date;
                                data_obj[i].date = parseDate.parse(data_obj[i].date);
                                data_obj[i].day = data_obj[i].date.getDate();
                                data_obj[i].minute = data_obj[i].date.getMinutes();
                                index++;
                            }
                            json_data = []
                            for (var i in data_obj) {
                                json_data.push(data_obj[i]);
                            }
                            csv_nest = d3.nest().key(function(d) {
                                    return d.day;
                                })
                                .entries(json_data);
                            for (var i in csv_nest) {
                                var raw = 0,
                                    multi = 0,
                                    sum = 0;
                                $.each(csv_nest[i].values, function(idx, d) {
                                    //                                console.log(d);
                                    if (d.resolution == 0)
                                        raw++;
                                    else
                                        multi++;
                                    sum++;
                                })
                                sumNum.push({
                                    rawNum: raw,
                                    multiNum: multi,
                                    count: sum
                                });
                            }
                            //                        console.log(sumNum);
                            draw_flag = 1;
                            drawAllDemo_auto();
                        }

                    },
                    error: function() {
                        console.log('失败');
                    }
                });
            }

            function arg_segSure() {
                seg_arg = [];
                //获取参数分割条件
                var ch = document.getElementsByName("arg_set");
                for (var i = 0; i < ch.length; i++) {
                    if (ch[i].checked) {
                        seg_arg += ch[i].id + ",";
                    }
                }
                seg_arg = seg_arg.slice(0, -1);
                $.ajax({
                    url: '/get_argMode',
                    type: 'GET',
                    data: {
                        args: seg_arg,
                        flag_y: temp_date['flag_y'],
                        flag_m: temp_date['flag_m']
                    },
                    success: function(arg) {
                        var temp_data = arg;
                        seg_data = [];
                        console.log(temp_data);
                        for (var i in temp_data) {
                            for (var j in temp_data[i][1]) {
                                seg_data.push({
                                    flag: parseInt(temp_data[i][0]),
                                    startDate: parseDate.parse(temp_data[i][1][j][0]),
                                    day: parseDate.parse(temp_data[i][1][j][0]).getDate(),
                                    endDate: parseDate.parse(temp_data[i][1][j][1]),
                                    setMax: temp_data[i][1][j][2],
                                    setMin: temp_data[i][1][j][3],
                                    diff: temp_data[i][1][j][4]
                                })
                            }
                        }
                        seg_nest = d3.nest().key(function(d) {
                                return d.day;
                            })
                            .entries(seg_data);
                        draw_flag = 2;
                        drawAllSeg_auto(temp_data.length)
                    },
                    error: function() {
                        console.log('加载失败');
                    }
                });
            }

            function get_mode() {
                //            console.log(11);
                var obj_select = document.getElementById("cycleWaterSet");
                var val_select  =  obj_select.options[obj_select.options.selectedIndex].value;
                var data = []
                data.push(d3.select("#mwMinSet").text());
                data.push(d3.select('#mwMaxSet').text());
                data.push(d3.select('#coalNum').text());
                data.push(val_select);
                //            console.log(data);
                $.ajax({
                    url: '/get_autoMode',
                    type: 'GET',
                    data: {
                        min: data[0],
                        max: data[1],
                        coal: data[2],
                        water: data[3]
                    },
                    success: function(arg) {
                        var data_obj = jQuery.parseJSON(arg[0]);
                        var type_flag = arg[1];
                        if (type_flag == 0) {
                            alert("没有满足条件的工况段!")
                        } else {
                            var index = 0;
                            var sumNum = [];

                            for (var i in data_obj) {
                                data_obj[i].index = index;
                                data_obj[i][selectMap] = parseInt(+data_obj[i][selectMap]);
                                data_obj[i].keyDate = data_obj[i].date;
                                data_obj[i].date = parseDate.parse(data_obj[i].date);
                                data_obj[i].day = data_obj[i].date.getDate();
                                data_obj[i].minute = data_obj[i].date.getMinutes();
                                index++;
                            }
                            json_data = []
                            for (var i in data_obj) {
                                json_data.push(data_obj[i]);
                            }
                            csv_nest = d3.nest().key(function(d) {
                                    return d.day;
                                })
                                .entries(json_data);
                            for (var i in csv_nest) {
                                var raw = 0,
                                    multi = 0,
                                    sum = 0;
                                $.each(csv_nest[i].values, function(idx, d) {
                                    //                                console.log(d);
                                    if (d.resolution == 0)
                                        raw++;
                                    else
                                        multi++;
                                    sum++;
                                })
                                sumNum.push({
                                    rawNum: raw,
                                    multiNum: multi,
                                    count: sum
                                });
                            }
                            //                        console.log(sumNum);
                            draw_auto(json_data, sumNum);
                        }

                    },
                    error: function() {
                        console.log('失败');
                    }
                });

            }

            //        function data_auto(f, s) {
            //            $.ajax({
            //                url: '/dataRaw',
            //                type: 'GET',
            //                data: {
            //                    selectType: selectMap,
            //                    property_1: f,
            //                    property_2: s,
            //                    interval: interval,
            //                    stat_obj: stat_obj
            //                },
            //                success: function(arg) {
            //                    json_obj = jQuery.parseJSON(arg[0]);
            //                    var stat_data = arg[1];
            //                    $('#dataTxt').text(selectMap + "： 平均值：" + stat_data.mean + "  最大值：" + stat_data.max + "  最小值：" + stat_data.min);
            //                    index = 0;
            //                    layer = 0;
            //                    for (var i in json_obj) {
            //                        json_obj[i].index = index;
            //                        json_obj[i][selectMap] = parseInt(+json_obj[i][selectMap]);
            //                        json_obj[i].keyDate = json_obj[i].date;
            //                        json_obj[i].date = parseDate.parse(json_obj[i].date);
            //                        json_obj[i].day = json_obj[i].date.getDate();
            //                        json_obj[i].minute = json_obj[i].date.getMinutes();
            //                        index++;
            //                    }
            //                    json_data = []
            //                    for (var i in json_obj) {
            //                        json_data.push(json_obj[i]);
            //                    }
            //                    draw_auto(json_data);
            //                },
            //                error: function() {
            //                    console.log('失败');
            //                }
            //            });
            //        };
            //
            function drawAllDemo_auto() {
                var obj_1 = document.getElementsByName("stroke_edit");
                for (var i = 0; i < obj_1.length; i++) {
                    obj_1[i].checked = false;
                }
                //工况颜色映射
                // colorScale：颜色级别
                colorScale = d3.scale.quantile() // 按分位数取值，可使每个区域内元素个数相等
                    .domain([0, buckets - 1, type_flag]) // 定义域
                    // domain([0, n, 数据的最大值]);
                    .range(seg_color_1); // 值域：是颜色数组，函数的返回值是代表某种颜色的字符串

                //加载像素热力图

                document.getElementById("calendar").innerHTML = "";
                init();
                  var timeextent = d3.extent(csv_data, function(d) {
                        return d.date;
                    })
                    $("#map_date").html("显示时间：" + convertDate(timeextent[0]) + "至" + convertDate(timeextent[1])+"</br>显示参数："+selectMap+"</br>工况条件：。。");
                var width = 1200,
                    height = 600;
                var svg = d3.select("div#calendar");
                //            color.domain(d3.extent(json_data, function(d) {
                //                return d[selectMap];
                //            }));
                color = d3.scale.quantize()
                    .domain(d3.extent(csv_data, function(d) {
                        console.log(selectMap + d[selectMap]);
                        if (selectMap == "MW" || selectMap == "MWD2") {
                            if (d[selectMap] > 400) {
                                return d[selectMap];
                            }
                        } else if (selectMap == "NOM") {
                            if (d[selectMap] > 2) {
                                return d[selectMap];
                            }
                        } else {
                            if (d[selectMap] != 0) {
                                return d[selectMap];
                            }
                        }
                    }))
                    .range(["#006837", "#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffbf", "#fee08b", "#fdae61", "#f46d43", "#d73027", "#a50026"]);
                var layer = d3.max(json_data, function(d) {
                    return d.date.getDate();
                }) - d3.min(json_data, function(d) {
                    return d.date.getDate();
                }) + 1;
                var rectSVG = svg.append("svg").attr("width", width).attr("height", (layer + 1) * cellheight).attr("class", "MW");
                var rectG = rectSVG.append('g').attr('class', 'rect -g');
                var y_label = rectG.selectAll
                var min_layer = d3.min(json_data, function(d) {
                    return d.date.getDate();
                });
                for (var i in csv_nest) {
                    rawCell = 0,
                        multiCell = 0;
                    //                if (sumNum[i].multiNum == 0) {
                    rawCell = multiCell = Math.floor(width / sumNum[i].count);
                    //                } else {
                    //                    rawCell = 0.3 * width / sumNum[i].rawNum;
                    //                    multiCell = 0.7 * width / sumNum[i].multiNum;
                    //                }
                    //console.log(csv_nest[i].key + "***" + rawCell + "|||" + multiCell);
                    var nowDate = json_data[0].date.getDate();
                    var num = 0;
                    var beforeResolution = -1;
                    //纵轴提示框
                    var text_height = parseInt(i * cellheight) + parseInt(cellheight);
                    if (i % 2 > 0) {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "none").text(csv_nest[i].key + "D");
                    } else {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "black").text(csv_nest[i].key + "D");
                    }


                    var rect = rectG.append('g').attr("transform", "translate(30,0)").attr("id", "g-" + i).selectAll(".minute").data(csv_nest[i].values).enter().append("rect").attr('id', function(d) {
                            return 'rect-' + d.index
                        }).attr("class", "minute").attr("width", function(d) {
                            if (d.resolution > 0)
                                return multiCell * 1;
                            else
                                return rawCell * 1;
                        }).attr("height", cellheight).attr("x", function(d) {
                            //判断分辨率种类 1：细分辩率，0：粗分辨率
                            //一小时60分钟 5分钟间隔 划分为12个元素，每个元素占piexlSize像素
                            // if (d.resolution == 0) {
                            if (beforeResolution > 0) {
                                num += multiCell * 1;
                            } else if (beforeResolution == 0) {
                                num += rawCell * 1;
                            } else {
                                num = 0;
                            }
                            beforeResolution = d.resolution;
                            return num;
                        }).attr("y", (i * cellheight)).style("fill", function(d) {
                            if (d.resolution > 0) {
                                //console.log(selectMap);
                                if (selectMap == "MW" || selectMap == "MWD2") {
                                    if (d[selectMap] < 400)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(get_rectColor(d.resolution));
                                } else {
                                    if (d[selectMap] <= 0.5)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(d[selectMap]);
                                }
                            } else {
                                if (selectMap == "MW" || selectMap == "MWD2") {
                                    if (d[selectMap] < 400)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(d[selectMap]);
                                } else {
                                    if (d[selectMap] <= 0.5)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(d[selectMap]);
                                }
                            }
                        })
                        .style("stroke-width", function(d) {
                            //                        if (d.resolution > 0)
                            //                            return 1;
                            //                        else
                            return 1;
                        })
                        .style('stroke', function(d) {
                            //                        if (d.resolution > 0)
                            //                            return 'black';
                            //                        else
                            return '#FFF';
                        }).style('opacity', function(d) {
                            if (d.resolution > 0) {
                                //                            console.log(d.MW);
                                return 1.0;
                            } else
                                return 0.5;
                        })
                        .on("click", mouseDown)
                        .on("mouseover", function(d) {
                            d3.selectAll(".minute").style("stroke-width", 1);
                            d3.select("#" + this.id).style("stroke-width", 2);

                        });
                    rect.append("title").text(function(d) {
                        return d.keyDate + "  " + selectMap + "：" + d[selectMap] + "种类：" + d.resolution;
                    });
                    beforeResolution = -1;
                }
                //定义横坐标
                var year = json_data[0].date.getFullYear(),
                    month = json_data[0].date.getMonth();
                var timeScale = d3.time.scale()
                    .domain([new Date(year, month, 1), new Date(year, month, 2)])
                    .range([0, 1152]);
                var xAxis = d3.svg.axis().scale(timeScale).ticks(23).orient('bottom');
                var defs = svg.append("svg").attr('width', 1180).attr('height', 30).append('g').attr("class", "x axis").attr("transform", "translate(32,10)").call(xAxis);

                //定义一个线性渐变  
                var defs = svg.append("svg").attr('width', 900).attr('height', 20).append("g").attr("transform","translate(30,5)");
                  var x = d3.scale.linear()
                            .domain(d3.extent(csv_data, function(d) {
//                        console.log(selectMap + d[selectMap]);
                        if (selectMap == "MW" || selectMap == "MWD2") {
                            if (d[selectMap] > 400) {
                                return d[selectMap];
                            }
                        } else if (selectMap == "NOM") {
                            if (d[selectMap] > 2) {
                                return d[selectMap];
                            }
                        } else {
                            if (d[selectMap] != 0) {
                                return d[selectMap];
                            }
                        }
                    }))
                            .range([0, 300]);

//                        console.log(x.domain())

                        var splitarr = function(From, To, Count) {
                            var Step = (To - From) / Count,
                                R = [From];

                            for (; --Count;) R.push(From += Step)
                            R.push(To)
                            return R
                        };

                        defs.selectAll("rect")
                            .data(splitarr(d3.min(x.domain()), d3.max(x.domain()), 10))
                            .enter()
                            .append("rect")
                            .attr("x", function(d) {
                                return x(d)
                            })
                            .attr("height", 10)
                            .attr("width", 30)
                            .attr("fill", function(d) {
//                                console.log(splitarr(d3.min(x.domain()), d3.max(x.domain()), 9))
                                return color(d);
                            }).attr("opacity",0.8);
                        defs.append("text")
                            .attr("transform", "translate(-22,10)")
                            .attr("font-size", 10)
                            .text("min");
                        defs.append("text")
                            .attr("transform", "translate(330,10)")
                            .attr("font-size", 10)
                            .text("max");
                //分割工况段标记颜色尺卡
                var defs = svg.append("svg").attr('width', 900).attr('height', 30).append("g").attr("transform","translate(30,0)");
                var arr = [];
                for (var i = 0; i < mode_class.length; i++) {
                    arr.push({
                        type:1,
                        index: i,
                        category: mode_class[i][0],
                        value: mode_class[i][1],
                        coal: mode_class[i][2],
                        mw: mode_class[i][3]
                    });
                }
                var modeRect = defs.selectAll(".modeColor").data(arr).enter().append("rect").attr('id', function(d) {
                    return 'modeRect-' + d.category;
                }).attr("class", "modeColor").attr("width", 100).attr("height", 15).attr("x", function(d) {
                    return d.index * 100;
                }).attr("y", 0).style('fill', function(d) {
                    if (selectMap == "MW")
                        return color(d.mw);
                    //                    return compute(color(d.mw));
                    else {
                        var val = 0;
                        for (var i in json_data) {
                            if (json_data[i].resolution == d.category) {
                                val = json_data[i][selectMap];
                                break;
                            }
                        }
                        return color(val);
                        //                    return compute(color(val));

                    }
                }).style('stroke', function(d) {
                    //                console.log(colorScale(d.coal) + "||" + d.coal);
                    return colorScale(d.coal);
                }).style('stroke-width', 2).on("mouseover", function(d) {
                    var select_color = document.getElementById(this.id).style.fill;
                    var obj = document.getElementsByClassName("rect-frame");
                    var stroke_color = document.getElementById(this.id).style.stroke;
                    for (var i = 0; i < obj.length; i++) {
                        if ((obj[i].style.fill == select_color) && (obj[i].style.stroke == stroke_color)) {
                            obj[i].style["stroke-width"] = 3;
                            obj[i].style["opacity"] = 1;
                        } else {
                            obj[i].style["stroke-width"] = 1;
                            obj[i].style["opacity"] = 0.7;
                        }
                    }
                }).on("mouseout", function() {
                    var obj = document.getElementsByClassName("rect-frame");
                    for (var i = 0; i < obj.length; i++) {
                        obj[i].style["stroke-width"] = 2;
                        obj[i].style["opacity"] = 1;
                    }
                }).on("click",function(d){
                    get_parallel(d.category,d.type);
                });
                defs.selectAll('demo-tip').data(arr).enter().append("text")
                    .attr("class", "demo-tip")
                    .text(function(d) {
                        return ">=" + parseInt(+(d.value / 100)) + "00  coal:" + d.coal;

                    })
                    .attr("x", function(d, i) {
                        return d.index * 100;
                    })
                    .attr("y", 25);


                //            for (var i = 0; i < mode_class.length; i++) {
                //                arr.push({
                //                    index: i,
                //                    category: mode_class[i][0],
                //                    value: mode_class[i][1]
                //                });
                //            }
                //            var modeRect = defs.selectAll(".modeColor").data(arr).enter().append("rect").attr('id', function(d) {
                //                return 'rect-' + d.category;
                //            }).attr("class", "modeColor").attr("width", 50).attr("height", 15).attr("x", function(d) {
                //                return d.index * 50;
                //            }).attr("y", 0).style('fill', function(d) {
                //                return compute(color(d.value));
                //            });
                //            defs.selectAll('demo-tip').data(arr).enter().append("text")
                //                .attr("class", "demo-tip")
                //                .text(function(d) { //">="+parseInt(+(d.value/100))+"00"; 获取整数范围
                //                    return d.value;
                //                })
                //                .attr("x", function(d, i) {
                //                    return d.index * 50;
                //                })
                //                .attr("y", 25);

            }

            function get_parallel(flag,type){
                if(document.getElementById('timeseries_0_1').innerHTML==="")
                    document.getElementById("line_div").style.display='none';
                document.getElementById("iframe").setAttribute('src', "../../goto_Parallel?flag_y="+temp_date['flag_y']+"&flag_m="+temp_date['flag_m']+"&flag="+flag+"&type="+type);
                
            }
            //绘制参数分割后的结果
            function drawAllSeg_auto(type_flag) {
                var obj_2 = document.getElementsByName("seg_edit");
                for (var i = 0; i < obj_2.length; i++) {
                    obj_2[i].checked = false;
                }
                //工况颜色映射
                // colorScale：颜色级别
                colorScale = d3.scale.quantile() // 按分位数取值，可使每个区域内元素个数相等
                    .domain([0, buckets - 1, type_flag]) // 定义域
                    // domain([0, n, 数据的最大值]);
                    .range(seg_color_1); // 值域：是颜色数组，函数的返回值是代表某种颜色的字符串

                //加载像素热力图

                document.getElementById("calendar").innerHTML = "";
                init();
                  var timeextent = d3.extent(csv_data, function(d) {
                        return d.date;
                    })
                    $("#map_date").html("显示时间：" + convertDate(timeextent[0]) + "至" + convertDate(timeextent[1])+"</br>显示参数："+selectMap);
                var width = 1200,
                    height = 600;
                var svg = d3.select("div#calendar");
                //            color.domain(d3.extent(json_data, function(d) {
                //                return d[selectMap];
                //            }));
                color = d3.scale.quantize()
                    .domain(d3.extent(csv_data, function(d) {
                        console.log(selectMap + d[selectMap]);
                        if (selectMap == "MW" || selectMap == "MWD2") {
                            if (d[selectMap] > 400) {
                                return d[selectMap];
                            }
                        } else if (selectMap == "NOM") {
                            if (d[selectMap] > 2) {
                                return d[selectMap];
                            }
                        } else {
                            if (d[selectMap] != 0) {
                                return d[selectMap];
                            }
                        }
                    }))
                    .range(["#006837", "#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffbf", "#fee08b", "#fdae61", "#f46d43", "#d73027", "#a50026"]);
                var layer = d3.max(json_data, function(d) {
                    return d.date.getDate();
                }) - d3.min(json_data, function(d) {
                    return d.date.getDate();
                }) + 1;
                var rectSVG = svg.append("svg").attr("width", width).attr("height", (layer + 1) * cellheight).attr("class", "MW_1");
                var rectG = rectSVG.append('g').attr('class', 'seg-g');
                //            .attr("transform", "translate(5,0)");
                var y_label = rectG.selectAll
                var min_layer = d3.min(json_data, function(d) {
                    return d.date.getDate();
                });
                for (var i in csv_nest) {
                    rawCell = 0,
                        multiCell = 0;
                    //                if (sumNum[i].multiNum == 0) {
                    rawCell = multiCell = width / sumNum[i].count;
                    //                } else {
                    //                    rawCell = 0.3 * width / sumNum[i].rawNum;
                    //                    multiCell = 0.7 * width / sumNum[i].multiNum;
                    //                }
                    //console.log(csv_nest[i].key + "***" + rawCell + "|||" + multiCell);
                    var nowDate = json_data[0].date.getDate();
                    var num = 0;
                    var beforeResolution = -1;
                    //纵轴提示框
                    var text_height = parseInt(i * cellheight) + parseInt(cellheight);
                    if (i % 2 > 0) {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "none").text(csv_nest[i].key + "D");
                    } else {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "black").text(csv_nest[i].key + "D");
                    }
                    //内容
                    var rect = rectG.append('g').attr("transform", "translate(30,0)").attr("id", "seg-g-" + i).selectAll(".segment").data(csv_nest[i].values).enter().append("rect").attr('id', function(d) {
                            return 'rect-seg-' + d.index
                        }).attr("class", "segment").attr("width", function(d) {
                            if (d.resolution > 0)
                                return multiCell * 1;
                            else
                                return rawCell * 1;
                        }).attr("height", cellheight).attr("x", function(d) {
                            //判断分辨率种类 1：细分辩率，0：粗分辨率
                            //一小时60分钟 5分钟间隔 划分为12个元素，每个元素占piexlSize像素
                            // if (d.resolution == 0) {
                            if (beforeResolution > 0) {
                                num += multiCell * 1;
                            } else if (beforeResolution == 0) {
                                num += rawCell * 1;
                            } else {
                                num = 0;
                            }
                            beforeResolution = d.resolution;
                            return num;
                        }).attr("y", (i * cellheight)).style("fill", function(d) {
                            if (d.resolution > 0) {
                                if (selectMap == "MW" || selectMap == "MWD2") {
                                    if (d[selectMap] < 400)
                                        return 'rgb(221,221,221)';
                                    else
                                        return color(get_rectColor(d.resolution));
                                }
                                //                                return compute(color(get_rectColor(d.resolution)));
                                else {
                                    if (d[selectMap] <= 0.5)
                                        return 'rgb(221,221,221)';
                                    else
                                        return color(d[selectMap]);

                                }
                                //                                return compute(color(d[selectMap]));
                            } else {
                                if (selectMap == "MW" || selectMap == "MWD2") {
                                    if (d[selectMap] < 400)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(d[selectMap]);
                                } else {
                                    if (d[selectMap] <= 0.5)
                                        return 'rgb(221, 221, 221)';
                                    else
                                        return color(d[selectMap]);
                                }
                            }
                            //                            return compute(color(d[selectMap]));
                        })
                        .style("stroke-width", function(d) {
                            //                        if (d.resolution > 0)
                            //                            return 1;
                            //                        else
                            return 1;
                        })
                        .style('stroke', function(d) {
                            //                        if (d.resolution > 0)
                            //                            return 'black';
                            //                        else
                            return '#FFF';
                        }).style('opacity', function(d) {
                            if (d.resolution > 0) {
                                //                            console.log(d.MW);
                                return 1.0;
                            } else
                                return 0.5;
                        })
                        .on("click", mouseDown)
                        .on("mouseover", function(d) {
                            d3.selectAll(".segment").style("stroke-width", 1);
                            d3.select("#" + this.id).style("stroke-width", 2);

                        });
                    rect.append("title").text(function(d) {
                        return d.keyDate + "  " + selectMap + "：" + d[selectMap] + "种类：" + d.resolution;
                    });
                    beforeResolution = -1;
                }
                //定义横坐标
                var year = json_data[0].date.getFullYear(),
                    month = json_data[0].date.getMonth();
                var timeScale = d3.time.scale()
                    .domain([new Date(year, month, 1), new Date(year, month, 2)])
                    .range([0, 1152]);
                var xAxis = d3.svg.axis().scale(timeScale).ticks(23).orient('bottom');
                var defs = svg.append("svg").attr('width', 1180).attr('height', 30).append('g').attr("class", "x axis").attr("transform", "translate(32,10)").call(xAxis);
                //定义一个线性渐变  
                var defs = svg.append("svg").attr('width', 900).attr('height', 20).append("g").attr("transform","translate(30,5)");
                  var x = d3.scale.linear()
                            .domain(color.domain())
                            .range([0, 300]);

                        console.log(x.domain())

                        var splitarr = function(From, To, Count) {
                            var Step = (To - From) / Count,
                                R = [From];

                            for (; --Count;) R.push(From += Step)
                            R.push(To)
                            return R
                        };

                        defs.selectAll("rect")
                            .data(splitarr(d3.min(x.domain()), d3.max(x.domain()), 10))
                            .enter()
                            .append("rect")
                            .attr("x", function(d) {
                                return x(d)
                            })
                            .attr("height", 10)
                            .attr("width", 30)
                            .attr("fill", function(d) {
//                                console.log(splitarr(d3.min(x.domain()), d3.max(x.domain()), 9))
                                return color(d);
                            }).attr("opacity",0.8);
                        defs.append("text")
                            .attr("transform", "translate(-22,10)")
                            .attr("font-size", 10)
                            .text("min");
                        defs.append("text")
                            .attr("transform", "translate(330,10)")
                            .attr("font-size", 10)
                            .text("max");
                //分割工况段标记颜色尺卡
                var defs = svg.append("svg").attr('width', 900).attr('height', 30);
                var arr = [];
                for (var i = 0; i < mode_class.length; i++) {
                    arr.push({
                        type:2,
                        index: i,
                        category: mode_class[i][0],
                        value: mode_class[i][1],
                        coal: mode_class[i][2],
                        mw: mode_class[i][3]
                    });
                }
                var modeRect = defs.selectAll(".modeColor").data(arr).enter().append("rect").attr('id', function(d) {
                    return 'modeRect-' + d.category;
                }).attr("class", "modeColor").attr("width", 100).attr("height", 15).attr("x", function(d) {
                    return d.index * 100;
                }).attr("y", 0).style('fill', function(d) {
                    if (selectMap == "MW")
                        return color(d.mw);
                    //                    return compute(color(d.mw));
                    else {
                        var val = 0;
                        for (var i in json_data) {
                            if (json_data[i].resolution == d.category) {
                                val = json_data[i][selectMap];
                                break;
                            }
                        }
                        return color(val);
                        //                    return compute(color(val));

                    }
                }).style('stroke', function(d) {
                    //                console.log(colorScale(d.coal) + "||" + d.coal);
                    return colorScale(d.coal);
                }).style('stroke-width', 3).on("mouseover", function(d) {
                    var select_color = document.getElementById(this.id).style.fill;
                    var obj = document.getElementsByClassName("rect-seg-frame");
                    var stroke_color = document.getElementById(this.id).style.stroke;
                    for (var i = 0; i < obj.length; i++) {
                        if ((obj[i].style.fill == select_color) && (obj[i].style.stroke == stroke_color)) {
                            obj[i].style["stroke-width"] = 3;
                            obj[i].style["opacity"] = 1;
                        } else {
                            obj[i].style["stroke-width"] = 1;
                            obj[i].style["opacity"] = 0.7;
                        }
                    }
                }).on("mouseout", function() {
                    var obj = document.getElementsByClassName("rect-seg-frame");
                    for (var i = 0; i < obj.length; i++) {
                        obj[i].style["stroke-width"] = 3;
                        obj[i].style["opacity"] = 1;
                    }
                }).on("click",function(d){
                    get_parallel(d.category,d.type);
                });
                defs.selectAll('demo-tip').data(arr).enter().append("text")
                    .attr("class", "demo-tip")
                    .text(function(d) {
                        return ">=" + parseInt(+(d.value / 100)) + "00  coal:" + d.coal;

                    })
                    .attr("x", function(d, i) {
                        return d.index * 100;
                    })
                    .attr("y", 25);
            }


            function draw_argCompare() {
                var width = 1200,
                    height = 600;
                var svg = d3.select("div#calendar_2");
                var rectSVG = svg.append("svg").attr("width", width).attr("height", height).attr("class", "MW_2");
                for (var i = 0; i < json_data.length; i++) {
                    console.log(1);
                }

            }

            function stroke_color(d) {
                for (var i = 0; i < mode_class.length; i++) {
                    if (mode_class[i][0] == d)
                        return mode_class[i][2];
                }
            }

            function get_rectColor(d) {
                for (var i = 0; i < mode_class.length; i++) {
                    if (mode_class[i][0] == d)
                        return mode_class[i][3];
                }
            }

            function get_mwLevel(d) {
                var y = d;
                if (d >= 900)
                    y = 950;
                if (d >= 800 && d < 900)
                    y = 850;
                if (d >= 700 && d < 800)
                    y = 750;
                if (d >= 600 && d < 700)
                    y = 650;
                if (d >= 500 && d < 600)
                    y = 550;
                return y;
            }
            //添加细节框
            function add_stroke(d) {
                switch (d) {
                    /*clear*/
                    case 0:
                        var rect_frame = d3.selectAll('.rect-frame');
                        if (rect_frame[0].length > 0)
                            rect_frame.remove();
                        for (var i in json_data) {
                            //if (json_data[i].resolution > 0) {
                            $("#rect-" + i).css("stroke", '#fff');
                            $("#rect-" + i).css("stroke-width", 0);
                            //}
                        }
                        break;
                    case 1: //add stroke
                        for (var i in json_data) {
                            if (json_data[i].resolution > 0) {
                                $("#rect-" + i).css("stroke", '#ccc');
                                $("#rect-" + i).css("stroke-width", 1);
                            }
                        }
                        break;
                    case 2:
                        for (var i in csv_nest) {
                            var beforeResolution = 0,
                                afterResolution = 0,
                                arr = csv_nest[i].values;
                            var rectG = d3.select("#g-" + i);
                            var x = 0,
                                y = 0,
                                t = 0;
                            for (var j in arr) {
                                if (arr[j].resolution > 0 && beforeResolution == 0) {
                                    //                                
                                    x = $("#rect-" + arr[j].index).attr('x')
                                    y = $("#rect-" + arr[j].index).attr('y')
                                    beforeResolution = arr[j].resolution;
                                    t = j;
                                }
                                if (arr[j].resolution > 0 && beforeResolution > 0 && arr[j].resolution != beforeResolution) {
                                    rectG.append('rect').attr("class", 'rect-frame').attr("id", 'rect-frame-' + j).attr("x", x).attr("y", y).attr("width", ((j - t) * multiCell)).attr("height", cellheight).style("stroke", colorScale(stroke_color(beforeResolution))).style("stroke-width", 2).style("fill", function() {
                                        var val = arr[j - 1][selectMap];
                                        if (selectMap == "MW")
                                            //                                        return compute(color(get_rectColor(arr[j - 1].resolution)));
                                            return color(get_rectColor(arr[j - 1].resolution));
                                        else
                                            return color(val);
                                        //                                        return compute(color(val));

                                    }).on("click", highSeg);
                                    beforeResolution = arr[j].resolution;
                                    x = $("#rect-" + arr[j].index).attr('x');
                                    y = $("#rect-" + arr[j].index).attr('y');
                                    t = j;
                                }
                                if ((arr[j].resolution == 0 && beforeResolution > 0) || (arr[j].resolution > 0 && j == arr.length - 1)) {
                                    rectG.append('rect').attr("class", 'rect-frame').attr("id", 'rect-frame-' + j).attr("x", x).attr("y", y).attr("width", ((j - t) * multiCell)).attr("height", cellheight).style("stroke", colorScale(stroke_color(beforeResolution))).style("stroke-width", 2).style("fill", function() {
                                        var val = arr[j - 1][selectMap];
                                        if (selectMap == "MW")
                                            return color(get_rectColor(arr[j - 1].resolution));
                                        //                                        return compute(color(get_rectColor(arr[j - 1].resolution)));
                                        else
                                            return color(val);

                                    }).on("click", highSeg);
                                    beforeResolution = arr[j].resolution;
                                }
                                beforeResolution = arr[j].resolution;
                            }
                        }
                        break;
                    case 2.1: //add rect
                        for (var i in csv_nest) {
                            var beforeResolution = 0,
                                afterResolution = 0,
                                arr = csv_nest[i].values;
                            var rectG = d3.select("#g-" + i);
                            var x = 0,
                                y = 0,
                                t = 0;
                            for (var j in arr) {
                                if (arr[j].resolution > 0 && beforeResolution == 0) {
                                    //                                console.log($("#rect-" + arr[j].index).attr('x'));
                                    x = $("#rect-" + arr[j].index).attr('x')
                                    y = $("#rect-" + arr[j].index).attr('y')
                                    beforeResolution = arr[j].resolution;
                                    t = j;
                                }
                                if (arr[j].resolution > 0 && beforeResolution > 0 && arr[j].resolution != beforeResolution) {
                                    rectG.append('rect').attr("class", 'rect-frame').attr("x", x).attr("y", y).attr("width", ((j - t) * multiCell)).attr("height", cellheight).style("stroke", '#black').style("stroke-width", 2).style("fill", function() {
                                        var val = arr[j - 1][selectMap];
                                        if (selectMap == "MW")
                                            //                                        return compute(color(get_rectColor(arr[j - 1].resolution)));
                                            return color(get_rectColor(arr[j - 1].resolution));
                                        else
                                            return color(val);
                                        //                                        return compute(color(val));

                                    }).on("click", highSeg);
                                    beforeResolution = arr[j].resolution;
                                    x = $("#rect-" + arr[j].index).attr('x');
                                    y = $("#rect-" + arr[j].index).attr('y');
                                    t = j;
                                }
                                if ((arr[j].resolution == 0 && beforeResolution > 0) || (arr[j].resolution > 0 && j == arr.length - 1)) {
                                    rectG.append('rect').attr("class", 'rect-frame').attr("x", x).attr("y", y).attr("width", ((j - t) * multiCell)).attr("height", cellheight).style("stroke", '#black').style("stroke-width", 2).style("fill", function() {
                                        var val = arr[j - 1][selectMap];
                                        if (selectMap == "MW")
                                            return color(get_rectColor(arr[j - 1].resolution));
                                        //                                        return compute(color(get_rectColor(arr[j - 1].resolution)));
                                        else
                                            //                                        return compute(color(val));
                                            return color(val);

                                    }).on("click", highSeg);
                                    beforeResolution = arr[j].resolution;
                                }
                                beforeResolution = arr[j].resolution;
                            }
                        }
                        break;
                    case 3: //add all stroke
                        for (var i in json_data) {
                            $("#rect-" + i).css("stroke", '#ccc');
                            $("#rect-" + i).css("stroke-width", 1);
                        }
                        break;
                    case 4: //edit all opacity =1
                        for (var i in json_data) {
                            $("#rect-" + i).css("opacity", 1);
                        }
                        break;
                }
            }

            d3.selectAll('.rect-frame').on('onclick', mouseDown);

            function highSeg(d) {
//                console.log(this.id);
                switch (d) {
                    case 0:
                        console.log(111);
                        break;
                    case 1:
                        console.log(222);
                        break;
                }
                //            console.log(111);
            }

            function add_segRect(d) {
                switch (d) {
                    case 0:
                        //清除
                        var rect_frame = d3.selectAll('.rect-seg-frame');
                        if (rect_frame[0].length > 0)
                            rect_frame.remove();

                        for (var i in json_data) {
                            //if (json_data[i].resolution > 0) {
                            $("#rect-seg-" + i).css("stroke", '#fff');
                            $("#rect-seg-" + i).css("stroke-width", 0);
                            //}
                        }
                        break;
                    case 1:
                        //添加rect
                        var arg = d3.keys(seg_data[0].diff);
                        for (var i in seg_data) {
                            var x = 0,
                                y = 0,
                                par_id, t = 0;
                            for (var j = 0; j < json_data.length; j++) {
                                if (json_data[j].resolution == seg_data[i].flag) {
                                    if ((json_data[j - 1].date < seg_data[i].startDate) && (json_data[j].date >= seg_data[i].startDate)) { //绘制方框
                                        //                                    console.log(j - 1);
                                        x = $("#rect-seg-" + json_data[j].index).attr('x');
                                        y = $("#rect-seg-" + json_data[j].index).attr('y');
                                        var s = document.getElementById("rect-seg-" + json_data[j].index);
                                        par = s.parentNode.id;
                                        t = j;
                                    }
                                    if ((json_data[j].date <= seg_data[i].endDate) && (json_data[j].date.getHours == 23 && json_data[j].date.getHours >= 50)) {
                                        var rectG = d3.select(par);
                                        rectG.append('rect').attr("class", 'rect-seg-frame').attr("id", 'rect-seg-frame-' + i).attr("x", x).attr("y", y).attr("width", ((j - t) * multiCell)).attr("height", cellheight).style("stroke", colorScale(stroke_color(json_data[j].resolution))).style("stroke-width", 2).style("fill", function() {
                                            var val = json_data[j - 1][selectMap];
                                            if (selectMap == "MW")
                                                return color(get_rectColor(json_data[j - 1].resolution));
                                            //                                            return compute(color(get_rectColor(json_data[j - 1].resolution)));
                                            else
                                                return color(val);
                                            return compute(color(val));

                                        }).on('click', draw_seg_line).on("mouseover", function(d) {
                                            d3.selectAll(".segment").style("stroke-width", 0);
                                            d3.selectAll(".rect-seg-frame").style("stroke-width", 2);
                                            d3.select("#" + this.id).style("stroke-width", 3);

                                        }).append("title").text(function() {
                                            var tip = "";
                                            for (var j in arg) {
                                                tip += "\n" + arg[j] + "  最大值：" + seg_data[i].setMax[arg[j]] + ",最小值：" + seg_data[i].setMin[arg[j]] + ",diff:" + seg_data[i].diff[arg[j]].toFixed(4) + ";";
                                            }
                                            tip = tip.slice(0, -1);
                                            return "工况详情： \n时间段：" + convertDate(seg_data[i].startDate) + "至" + convertDate(seg_data[i].startDate) + "; " + tip;
                                        });
                                    } else if ((json_data[j].date <= seg_data[i].endDate) && (json_data[j + 1].date > seg_data[i].endDate)) { //结束绘制
                                        //                                    console.log(j - t);
                                        var rectG = d3.select("#" + par);
                                        rectG.append('rect').attr("class", 'rect-seg-frame').attr("id", 'rect-seg-frame-' + i).attr("x", x).attr("y", y).attr("width", ((j - t + 1) * multiCell)).attr("height", cellheight).style("stroke", colorScale(stroke_color(json_data[j].resolution))).style("stroke-width", 2).style("fill", function() {
                                            var val = json_data[j - 1][selectMap];
                                            if (selectMap == "MW")
                                                return color(get_rectColor(json_data[j - 1].resolution));
                                            //                                            return compute(color(get_rectColor(json_data[j - 1].resolution)));
                                            else
                                                //                                            return compute(color(val));
                                                return color(val);

                                        }).on('click', draw_seg_line).on("mouseover", function(d) {
                                            d3.selectAll(".segment").style("stroke-width", 0);
                                            d3.selectAll(".rect-seg-frame").style("stroke-width", 2);
                                            d3.select("#" + this.id).style("stroke-width", 3);

                                        }).append("title").text(function() {
                                            var tip = "";
                                            for (var j in arg) {
                                                tip += "\n" + arg[j] + "  最大值：" + seg_data[i].setMax[arg[j]] + ",最小值：" + seg_data[i].setMin[arg[j]] + ",diff:" + seg_data[i].diff[arg[j]].toFixed(4) + ";";
                                            }
                                            tip = tip.slice(0, -1);
                                            return "工况详情： \n时间段：" + convertDate(seg_data[i].startDate) + "至" + convertDate(seg_data[i].startDate) + "; " + tip;
                                        });
                                    }
                                }
                            }
                        }
                        break;
                    case 2:
                        var stroke_index = [];
                        for (var i in seg_data) {
                            for (var j = 0; j < json_data.length; j++) {
                                if (json_data[j].resolution == seg_data[i].flag) {
                                    if ((json_data[j - 1].date < seg_data[i].startDate) && (json_data[j].date >= seg_data[i].startDate)) { //绘制方框
                                        stroke_index.push(j);
                                    }
                                    stroke_index.push(j);
                                    if ((json_data[j].date <= seg_data[i].endDate) && (json_data[j].date.getHours == 23 && json_data[j].date.getHours >= 50)) {
                                        stroke_index.push(j);
                                    } else if ((json_data[j].date <= seg_data[i].endDate) && (json_data[j + 1].date > seg_data[i].endDate)) {
                                        stroke_index.push(j);
                                    }
                                }
                            }
                        }

                        for (var i in stroke_index) {
                            $("#rect-seg-" + stroke_index[i]).css("stroke", '#ccc');
                            $("#rect-seg-" + stroke_index[i]).css("stroke-width", 1);
                        }
                        break;

                }
            }

            function convertDate(d) {
//                console.log(d.getDate());
                return d.getFullYear() + "-" + ((d.getMonth() + 1).toString().length>1?(d.getMonth() + 1):("0"+(d.getMonth() + 1)))+ "-" + (d.getDate().toString().length>1?d.getDate():("0"+d.getDate())) + " " + (d.getHours().toString().length>1?d.getHours():("0"+d.getHours())) + ":" + (d.getMinutes().toString().length>1?d.getMinutes():("0"+d.getMinutes()))  + ":" +(  d.getSeconds().toString().length>1?  d.getSeconds():("0"+  d.getSeconds()));
            }

            function draw_auto(json_data, sumNum) {
                //加载像素热力图
                document.getElementById("calendar").innerHTML = "";
                init();
                var width = 1200,
                    height = 600;
                var svg = d3.select("div#calendar");
                color.domain(d3.extent(json_data, function(d) {
                    return d[selectMap];
                }));
                var layer = d3.max(json_data, function(d) {
                    return d.date.getDate();
                }) - d3.min(json_data, function(d) {
                    return d.date.getDate();
                }) + 1;
                var rectSVG = svg.append("svg").attr("width", width).attr("height", (layer + 1) * cellheight).attr("class", "MW");
                var rectG = rectSVG.append('g').attr('class', 'rect -g').attr("transform", "translate(5,0)");
                var y_label = rectG.selectAll
                var min_layer = d3.min(json_data, function(d) {
                    return d.date.getDate();
                });
                for (var i in csv_nest) {
                    var rawCell = 0,
                        multiCell = 0;
                    if (sumNum[i].multiNum == 0) {
                        rawCell = multiCell = width / sumNum[i].count;
                    } else {
                        rawCell = 0.3 * width / sumNum[i].rawNum;
                        multiCell = 0.7 * width / sumNum[i].multiNum;
                    }
                    //                console.log(csv_nest[i].key + "***" + rawCell + "|||" + multiCell);
                    var nowDate = json_data[0].date.getDate();
                    var num = 0;
                    var beforeResolution = -1;
                    var rect = rectG.append('g').selectAll(".minute").data(csv_nest[i].values).enter().append("rect").attr('id', function(d) {
                            return 'rect-' + d.index
                        }).attr("class", "minute").attr("width", function(d) {
                            if (d.resolution == 1)
                                return multiCell * 1;
                            else
                                return rawCell * 1;
                        }).attr("height", cellheight).attr("x", function(d) {
                            //判断分辨率种类 1：细分辩率，0：粗分辨率
                            //一小时60分钟 5分钟间隔 划分为12个元素，每个元素占piexlSize像素
                            // if (d.resolution == 0) {
                            if (beforeResolution == 1) {
                                num += multiCell * 1;
                            } else if (beforeResolution == 0) {
                                num += rawCell * 1;
                            } else {
                                num = 0;
                            }
                            beforeResolution = d.resolution;
                            return num;
                        }).attr("y", (i * cellheight)
                            //                            function(d) {
                            //                        return (d.day - min_layer) * cellheight;
                            //                }
                        ).style("fill", function(d) {
                            return compute(color(d[selectMap]));
                        }).style("stroke-width", strokeSize)
                        .style('stroke', function(d) {
                            if (d.resolution == 1)
                                return 'black';
                        }).style('opacity', function(d) {
                            if (d.resolution == 1)
                                return 1.0;
                            else
                                return 0.5;
                        })
                        //.on("mouseover",mouseover)
                        .on("mousedown", mouseDown);
                    rect.append("title").text(function(d) {
                        return d.keyDate + "  " + selectMap + "：" + d[selectMap];
                    });
                    beforeResolution = -1;
                }

            }

            function draw_org() {
  var timeextent = d3.extent(csv_data, function(d) {
                        return d.date;
                    })
                    $("#map_date").html("起始时间：" + convertDate(timeextent[0]) + "</br>终止时间：" + convertDate(timeextent[1])+"</br>显示参数："+selectMap);
                colorScale = d3.scale.quantize()
                    .domain(d3.extent(csv_data, function(d) {
                        //                    console.log(selectMap + d[selectMap]);
                        if (selectMap == "MW" || selectMap == "MWD2") {
                            if (d[selectMap] > 400) {
                                return d[selectMap];
                            }
                        } else if (selectMap == "NOM") {
                            if (d[selectMap] > 2) {
                                return d[selectMap];
                            }
                        } else {
                            if (d[selectMap] != 0) {
                                return d[selectMap];
                            }
                        }
                    }))
                    .range(["#006837", "#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffbf", "#fee08b", "#fdae61", "#f46d43", "#d73027", "#a50026"]);

                //加载像素热力图
                //console.log($("#calender").innerWidth());
                document.getElementById("calendar").innerHTML = "";
                init();
                var width = 1200,
                    height = 600;
                var svg = d3.select("div#calendar");
                color.domain(d3.extent(csv_data, function(d) {
                    return d[selectMap];
                }));
                var layer = d3.max(csv_data, function(d) {
                    return d.date.getDate();
                }) - d3.min(csv_data, function(d) {
                    return d.date.getDate();
                }) + 1;
                var rectSVG = svg.append("svg").attr("width", width).attr("height", (layer + 1) * cellheight).attr("class", "MW");
                var rectG = rectSVG.append('g').attr('class', 'rect -g');
                var y_label = rectG.selectAll
                var min_layer = d3.min(csv_data, function(d) {
                    return d.date.getDate();
                });
                for (var i in csv_nest) {
                    rawCell = 0,
                        //                if (sumNum[i].multiNum == 0) {
                        rawCell = Math.floor(width / csv_nest[i].values.length);
                    //                } else {
                    //                    rawCell = 0.3 * width / sumNum[i].rawNum;
                    //                    multiCell = 0.7 * width / sumNum[i].multiNum;
                    //                }
                    //console.log(csv_nest[i].key + "***" + rawCell + "|||" + multiCell);
                    var nowDate = csv_data[0].date.getDate();
                    var num = 0;
                    //纵轴提示框
                    var text_height = parseInt(i * cellheight) + parseInt(cellheight);
                    if (i % 2 > 0) {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "none").text(csv_nest[i].key + "D");
                    } else {
                        var tip = rectG.append("text").attr("width", 25).attr("height", cellheight).attr("transform", "translate(5," + text_height + ")").style("text-anchor", "left").style("font-size", "12px").style("display", "black").text(csv_nest[i].key + "D");
                    }


                    var rect = rectG.append('g').attr("transform", "translate(30,0)").attr("id", "g-" + i).selectAll(".minute").data(csv_nest[i].values).enter().append("rect").attr('id', function(d) {
                            return 'rect-' + d.index
                        }).attr("class", "minute").attr("width", function(d) {
                            return rawCell * 1;
                        }).attr("height", cellheight).attr("x", function(d) {
                            //判断分辨率种类 1：细分辩率，0：粗分辨率
                            //一小时60分钟 5分钟间隔 划分为12个元素，每个元素占piexlSize像素
                            // if (d.resolution == 0) {
                            num += rawCell * 1;
                            return num;
                        }).attr("y", (i * cellheight)).style("fill", function(d) {
                            if (selectMap == "MW" || selectMap == "MWD2") {
                                if (d[selectMap] >= 400)
                                    return colorScale(d[selectMap]);
                                else
                                    return 'rgb(221, 221, 221)';
                            } else {
                                if (d[selectMap] <= 0.5)
                                    return 'rgb(221, 221, 221)';
                                else
                                    return colorScale(d[selectMap]);
                            }
                        })
                        .style("stroke-width", function(d) {
                            return 1;
                        })
                        .style('stroke', function(d) {
                            return '#FFF';
                        }).style('opacity', function(d) {
                            return 0.8;
                        })
                                        .on("click", mouseDown);
                    //                    .on("mouseover", function(d) {
                    //                        d3.selectAll(".minute").style("stroke-width", 0);
                    //                        d3.select("#" + this.id).style("stroke-width", 2);
                    //
                    //                    });
                    rect.append("title").text(function(d) {
                        return d.keyDate + "  " + selectMap + ":" + d[selectMap];
                    });
                }
                //定义横坐标
                var year = csv_data[0].date.getFullYear(),
                    month = csv_data[0].date.getMonth();
                var timeScale = d3.time.scale()
                    .domain([new Date(year, month, 1), new Date(year, month, 2)])
                    .range([0, 1152]);
                var xAxis = d3.svg.axis().scale(timeScale).ticks(23).orient('bottom');
                var defs = svg.append("svg").attr('width', 1180).attr('height', 30).append('g').attr("class", "x axis").attr("transform", "translate(32,10)").call(xAxis);

                //定义一个线性渐变  
                var defs = svg.append("svg").attr('width', 900).attr('height', 20).append("g").attr("transform","translate(30,5)");
                  var x = d3.scale.linear()
                            .domain(colorScale.domain())
                            .range([0, 300]);

                        console.log(x.domain())

                        var splitarr = function(From, To, Count) {
                            var Step = (To - From) / Count,
                                R = [From];

                            for (; --Count;) R.push(From += Step)
                            R.push(To)
                            return R
                        };

                        defs.selectAll("rect")
                            .data(splitarr(d3.min(x.domain()), d3.max(x.domain()), 10))
                            .enter()
                            .append("rect")
                            .attr("x", function(d) {
                                return x(d)
                            })
                            .attr("height", 10)
                            .attr("width", 30)
                            .attr("fill", function(d) {
//                                console.log(splitarr(d3.min(x.domain()), d3.max(x.domain()), 9))
                                return colorScale(d);
                            }).attr("opacity",0.8);
                        defs.append("text")
                            .attr("transform", "translate(-22,10)")
                            .attr("font-size", 10)
                            .text("min");
                        defs.append("text")
                            .attr("transform", "translate(330,10)")
                            .attr("font-size", 10)
                            .text("max");

//                var defs = svg.append("svg").attr('width', 900).attr('height', 20);
//
//                var linearGradient = defs.append("linearGradient")
//                    .attr("id", "linearColor")
//                    .attr("x1", "0%")
//                    .attr("y1", "0%")
//                    .attr("x2", "100%")
//                    .attr("y2", "0%");
//
//                var stop1 = linearGradient.append("stop")
//                    .attr("offset", "0%")
//                    .style("stop-color", a.toString());
//
//                var stop2 = linearGradient.append("stop")
//                    .attr("offset", "100%")
//                    .style("stop-color", b.toString());
//
//                var colorRect = defs.append("rect")
//                    .attr("x", 0)
//                    .attr("y", 0)
//                    .attr("width", 200)
//                    .attr("height", 15)
//                    .style("fill", "url(#" + linearGradient.attr("id") + ")");
                //            //分割工况段标记颜色尺卡
                
                
                //            var defs = svg.append("svg").attr('width', 900).attr('height', 30);
                //            var arr = [];
                //            for (var i = 0; i < mode_class.length; i++) {
                //                arr.push({
                //                    index: i,
                //                    category: mode_class[i][0],
                //                    value: mode_class[i][1],
                //                    coal: mode_class[i][2],
                //                    mw: mode_class[i][3]
                //                });
                //            }
                //            var modeRect = defs.selectAll(".modeColor").data(arr).enter().append("rect").attr('id', function(d) {
                //                return 'modeRect-' + d.category;
                //            }).attr("class", "modeColor").attr("width", 100).attr("height", 15).attr("x", function(d) {
                //                return d.index * 100;
                //            }).attr("y", 0).style('fill', function(d) {
                //                if (selectMap == "MW")
                //                    return compute(color(d.mw));
                //                else {
                //                    var val = 0;
                //                    for (var i in csv_data) {
                //                        if (csv_data[i].resolution == d.category) {
                //                            val = csv_data[i][selectMap];
                //                            break;
                //                        }
                //                    }
                //                    return compute(color(val));
                //
                //                }
                //            }).style('stroke', function(d) {
                //                //                console.log(colorScale(d.coal) + "||" + d.coal);
                //                return colorScale(d.coal);
                //            }).style('stroke-width', 2).on("mouseover", function(d) {
                //                var select_color = document.getElementById(this.id).style.fill;
                //                var obj = document.getElementsByClassName("rect-frame");
                //                var stroke_color = document.getElementById(this.id).style.stroke;
                //                for (var i = 0; i < obj.length; i++) {
                //                    if ((obj[i].style.fill == select_color) && (obj[i].style.stroke == stroke_color)) {
                //                        obj[i].style["stroke-width"] = 3;
                //                        obj[i].style["opacity"] = 1;
                //                    } else {
                //                        obj[i].style["stroke-width"] = 1;
                //                        obj[i].style["opacity"] = 0.7;
                //                    }
                //                }
                //            }).on("mouseout", function() {
                //                var obj = document.getElementsByClassName("rect-frame");
                //                for (var i = 0; i < obj.length; i++) {
                //                    obj[i].style["stroke-width"] = 2;
                //                    obj[i].style["opacity"] = 1;
                //                }
                //            });
                //            defs.selectAll('demo-tip').data(arr).enter().append("text")
                //                .attr("class", "demo-tip")
                //                .text(function(d) {
                //                    return ">=" + parseInt(+(d.value / 100)) + "00  coal:" + d.coal;
                //
                //                })
                //                .attr("x", function(d, i) {
                //                    return d.index * 100;
                //                })
                //                .attr("y", 25);
                //        }

                //        function draw() {
                //            //加载像素热力图
                //            document.getElementById("calendar").innerHTML = "";
                //            init();
                //            var width = ((24 * 60 / interval) + 10) * cellSize,
                //                height = 600;
                //            var svg = d3.select("div#calendar");
                //            var layer = 1;
                //            var flag = new Array();
                //            for (var j in csv_nest) {
                //                var m = false;
                //                for (var i in csv_nest[j].values) {
                //                    var keyDate = csv_nest[j].values[i].keyDate;
                //                    var sDate = selectS.getFullYear() + "-" + ((selectS.getMonth() + 1) < 10 ? "0" : "") + (selectS.getMonth() + 1) + "-" + (selectS.getDate() < 10 ? "0" : "") + selectS.getDate();
                //                    var eDate = selectE.getFullYear() + "-" + ((selectE.getMonth() + 1) < 10 ? "0" : "") + (selectE.getMonth() + 1) + "-" + (selectE.getDate() < 10 ? "0" : "") + selectE.getDate();
                //                    if (keyDate < sDate) break;
                //                    else if (keyDate > eDate) break;
                //                    else {
                //                        m = true;
                //                    }
                //                }
                //                if (m) layer++;
                //                flag.push(m);
                //            }
                //            var rectSVG = svg.append("svg").attr("width", width).attr("height", layer * cellheight).attr("class", "MW");
                //            var rectG = rectSVG.append('g').attr('class', 'rect -g').attr("transform", "translate(5,0)");
                //            var h = 0;
                //            for (var j in flag) {
                //                if (flag[j]) {
                //                    drawRect(csv_nest[j].values, h++, rectG);
                //                }
                //            }
                //            var aN = new Array();
                //            for (var i in num) {
                //                aN.push(num[i][selectMap])
                //            }
                //            return "平均值：" + d3.mean(aN).toFixed(2) + "  最大值：" + d3.max(aN) + "  最小值：" + d3.min(aN);
                //        }
            }
            //确定像素块Y坐标位置
            function getY(d) {
                return d * cellheight;
            }
            //获取所属组的时间点y-m-s
            function readDate(d) {
                return d.keyDate;
            }
            //绘制小方块像素点
            function drawRect(data, c, rectG) {
                var flag = false;
                for (var i in data) {
                    if (data[i].date >= selectS && data[i].date <= selectE) {
                        num.push(data[i]);
                        flag = true;
                    }
                }
                if (flag) {
                    var ty = cellSize - 2;
                    var rect = rectG.append('g').selectAll(".minute").data(num).enter().append("rect").attr('id', function(d) {
                            return 'rect-' + d.index
                        }).attr("class", "minute").attr("width", cellSize).attr("height", cellheight).attr("x", function(d) {
                            //一小时60分钟 5分钟间隔 划分为12个元素，每个元素占piexlSize像素
                            return (d.date.getHours() * (60 / interval) + d.date.getMinutes() / interval) * cellSize;
                        }).attr("y", getY(c)).style("fill", function(d) {
                            return compute(color(d[selectMap]));
                        }).style("stroke-width", strokeSize)
                        //.on("mouseover",mouseover)
                        .on("mousedown", mouseDown);
                    rect.append("title").text(function(d) {
                        return d.keyDate + " " + d.date.getHours() + ":" + d.date.getMinutes() + "  发电功率为:" + d[selectMap];
                    });
                }
            }

            var selectDate = new Array(2);

            function draw_seg_line() {
                var seg_id = this.id.split('-')[3];
                var data = seg_data[seg_id];
                selectDate[0] = convertDate(data.startDate);
                selectDate[1] = convertDate(data.endDate);
                //加载显示原始数据
                $.ajax({
                    url: '/line_raw',
                    type: 'GET',
                    data: {
                        date: selectDate[0] + "," + selectDate[1],
                        flag_y: temp_date['flag_y'],
                        flag_m: temp_date['flag_m']
                    },
                    success: function(arg) {
                        var data_obj = jQuery.parseJSON(arg[0]);
                        var dim = arg[1];
                        //console.log(data_obj);
                        index = 0;
                        for (var i in data_obj) {
                            data_obj[i].index = index++;
                            data_obj[i].keyDate = data_obj[i].date;
                            data_obj[i].date = parseDate.parse(data_obj[i].date);
                        }
                        csv_range = [], line_obj = [], line_brush_selection = [];
                        var raw_data = [];
                        for (var i in data_obj) {
                            raw_data.push(data_obj[i]);
                        }
                        document.getElementById("line_div").display='black';
                        timeseries('timeseries_0_1', 1, raw_data, selectDate, 0, true, false);
                        timeseries('timeseries_0_2', 2, raw_data, selectDate, 0, true, false);
                    },
                    error: function() {
                        console.log('失败');
                    }
                });
            }

            function mouseDown(d) {
                if (drawflag == 0) {
                    firstIndex = d.index;
                    selectDate[0] = d.keyDate;
                }
                drawflag++;
                if (drawflag == 2) {
                    //				d3.selectAll('rect').style("opacity", 0.5);
                    if (d.index <= firstIndex) {
                        alert("选取时间点小于前一个,请重新选择");
                        drawflag = 1;
                    } else {
                        secondIndex = d.index;
                        selectDate[1] = d.keyDate;
                        //选中的rect改变透明度
                        var rect = d3.selectAll('.minute').style("stroke", '');
                        for (var i = firstIndex; i <= secondIndex; i++) {
                            $("#rect-" + i).css("stroke", 'black');
                            $("#rect-" + i).css("stroke-right", '');
                        }
                        var j = d.index;
                        //加载显示原始数据
                        $.ajax({
                            url: '/line_raw',
                            type: 'GET',
                            data: {
                                date: selectDate[0] + "," + selectDate[1],
                                flag_y: temp_date['flag_y'],                       flag_m: temp_date['flag_m']
                            },
                            success: function(arg) {
                                var data_obj = jQuery.parseJSON(arg[0]);
                                var dim = arg[1];
                                console.log(data_obj);
                                index = 0;
                                for (var i in data_obj) {
                                    data_obj[i].index = index++;
                                    data_obj[i].keyDate = data_obj[i].date;
                                    data_obj[i].date = parseDate.parse(data_obj[i].date);
                                }
                                csv_range = [], line_obj = [], line_brush_selection = [];
                                var raw_data = [];
                                for (var i in data_obj) {
                                    raw_data.push(data_obj[i]);
                                }
                                console.log(raw_data);
                                timeseries('timeseries_0_1', 1, raw_data, selectDate, 0, true, false);
                                timeseries('timeseries_0_2', 2, raw_data, selectDate, 0, true, false);
                            },
                            error: function() {
                                console.log('失败');
                            }
                        });
                        // 寻找相同工况的稳定段， 统计显示
                        <!--function setIframe(){-->
                        <!--}-->
                        //                        load_coordinate();
                        drawflag = 0;
                    }
                    //                console.log(brush_obj);
                }
            }
            //
            //        function load_coordinate() {
            //            $.ajax({
            //                url: '/coordinate_stat',
            //                type: 'GET',
            //                data: {
            //                    date: selectDate[0] + "," + selectDate[1]
            //                },
            //                success: function(arg) {
            //                    var mwData = arg[0];
            //                    var allDate = arg[1];
            //                    d3.select("#cod_detail").text("截取时间范围为：" + allDate[0] + "到" + allDate[1] + "   截取稳定工况的：MW范围[" + mwData[0] + "," + mwData[1] + "],标准差阈值为：" + mwData[2] + "");
            //                    //create_div_layoutChange();
            //                    document.getElementById("iframe").setAttribute('src', 'http://127.0.0.1:5000/coordinate.html');
            //                    csv_range = [];
            //                },
            //                error: function() {
            //                    console.log('失败');
            //                }
            //            });
            //        }
            //
            /****detail模块开始****/

            function data_select() {
                // alert(222);
                // var select_value = d.options[d.options.selectedIndex].value;
            }

            function show_layout() {
                //alert(111);
                var data_type = document.getElementById("data_select");
                var layout_type = document.getElementById("layout_select");
                var data_value = data_type.options[data_type.options.selectedIndex].value;
                var layout_value = layout_type.options[layout_type.options.selectedIndex].value;
                if (data_value == "")
                    alert("请先选择数据类型");
                else {
                    switch (data_value) {
                        case "1":
                            switch (layout_value) {
                                case "1":
                                    draw_detail_coordinate(cord_f, cord_s);
                                    break;
                                case "2":
                                    draw_detail_scatter(cord_f, cord_s);
                                    break;
                                default:
                                    alert("请选择布局");
                            }
                            break;
                        case "2":
                            switch (layout_value) {
                                case "1":
                                    draw_auto_coordinate(cord_f, cord_s);
                                    break;
                                case "2":
                                    draw_auto_scatter(cord_f, cord_s);
                                    break;
                                default:
                                    alert("请选择布局");
                            }

                            break;
                    }
                }
            }
            /****detail模块结束****/
            /***细节平行坐标显示模块--开始****/
            function draw_detail_coordinate(f, s) {
                $.ajax({
                    url: '/coordinate_detail',
                    type: 'GET',
                    data: {
                        date: f + "," + s
                    },
                    success: function(arg) {
                        var mwData = arg;
                        d3.select("#cod_detail").text("选取工况详情：date范围" + f + "到" + s + "MW范围[" + mwData[0] + "," + mwData[1] + "],标准差阈值为：" + mwData[2] + "");
                        //                create_div_layoutChange(f, s);
                        document.getElementById("iframe").setAttribute('src', 'http://127.0.0.1:5000/detail_coordinate.html');
                        csv_range = [];
                    },
                    error: function() {
                        console.log('失败');
                    }
                });
            }
            /***细节平行坐标显示模块--结束****/
            //        /***细节散点矩阵显示模块--开始****/
            //        function draw_detail_scatter(f, s) {
            //            $.ajax({
            //                url: '/coordinate_detail',
            //                type: 'GET',
            //                data: {
            //                    date: f + "," + s
            //                },
            //                success: function(arg) {
            //                    var mwData = arg;
            //                    d3.select("#cod_detail").text("选取工况详情：date范围" + f + "到" + s + "MW范围[" + mwData[0] + "," + mwData[1] + "],标准差阈值为：" + mwData[2] + "");
            //                    //                create_div_layoutChange(f, s);
            //                    document.getElementById("iframe").setAttribute('src', 'http://127.0.0.1:5000/detail_scatter.html');
            //                    csv_range = [];
            //                },
            //                error: function() {
            //                    console.log('失败');
            //                }
            //            });
            //        }
            //        /***细节散点矩阵显示模块--结束****/
            //        /******细节数据模块结束********/
            //
            //        /*****统计数据模块开始***/
            //        /***统计值平行坐标显示模块--开始****/
            //        function draw_auto_coordinate(f, s) {
            //            $.ajax({
            //                url: '/coordinate_stat',
            //                type: 'GET',
            //                data: {
            //                    date: f + "," + s
            //                },
            //                success: function(arg) {
            //                    var mwData = arg[0];
            //                    var allDate = arg[1];
            //                    d3.select("#cod_detail").text("截取时间范围为：" + allDate[0] + "到" + allDate[1] + "   截取稳定工况的：date范围" + f + "到" + s + "MW范围[" + mwData[0] + "," + mwData[1] + "],标准差阈值为：" + mwData[2] + "");
            //                    //                create_div_layoutChange(f, s);
            //                    document.getElementById("iframe").setAttribute('src', 'http://127.0.0.1:5000/coordinate.html');
            //                    csv_range = [];
            //                },
            //                error: function() {
            //                    console.log('失败');
            //                }
            //            });
            //        }
            //        /***统计值平行坐标显示模块--结束****/
            //
            //        /***统计值散点图显示模块--开始****/
            //        function draw_auto_scatter(f, s) {
            //            $.ajax({
            //                url: '/coordinate_stat',
            //                type: 'GET',
            //                data: {
            //                    date: f + "," + s
            //                },
            //                success: function(arg) {
            //                    var mwData = arg[0];
            //                    var allDate = arg[1];
            //                    d3.select("#cod_detail").text("截取时间范围为：" + allDate[0] + "到" + allDate[1] + "   截取稳定工况的：date范围" + f + "到" + s + "MW范围[" + mwData[0] + "," + mwData[1] + "],标准差阈值为：" + mwData[2] + "");
            //                    //                create_div_layoutChange(f, s);
            //                    document.getElementById("iframe").setAttribute('src', 'http://127.0.0.1:5000/scatter.html');
            //                    csv_range = [];
            //                },
            //                error: function() {
            //                    console.log('失败');
            //                }
            //            });
            //
            //        }
            //        /****统计值散点图模块结束****/
            //        /*****统计模块数据结束****/
            //        //        function show_layout(d) {
            //        //            var select_value = d.options[d.options.selectedIndex].value;
            //        //            //要加载的数据
            //        //            //			var file_1min = ["angleABCDEF_march_1min.csv", "smoke_march_1min.csv"];
            //        //            var file_1min = ["angleABCDEF_march_1min.csv", "smoke_march_1min.csv", "AGP20160301.csv", "onceminiwater_march_1min.csv", "secondminiwater_march_1min.csv", "superHeat20160301new.csv", "zk20160301.csv"];
            //        //            //初始化显示div内容
            //        //            var div_layout_show = document.getElementById('layout_show');
            //        //            div_layout_show.innerHTML = "";
            //        //            var newDate, m = 1;
            //        //            switch (select_value) {
            //        //                case "1":
            //        //                    var newDate, m = 1;
            //        //                    for (var i = 0; i < file_1min.length; i++) {
            //        //                        var div_coordinate = document.createElement("div")
            //        //                        div_coordinate.setAttribute("id", "timeseries_" + (i + 1));
            //        //                        div_coordinate.setAttribute("style", "width:960px;height:220px;margin:20px 20px");
            //        //                        div_layout_show.appendChild(div_coordinate);
            //        //                        var file_name = file_1min[i];
            //        //                        var file_dir = "data/";
            //        //                        d3.csv((file_dir + file_name), typeEF, function(error, csv) {
            //        //                            timeseries('timeseries_' + m, m, csv, selectDate, 1, true, false);
            //        //                            m++;
            //        //                        })
            //        //                    }
            //        //                    break;
            //        //                case "2":
            //        //                    var newDate, m = 2;
            //        //                    for (var i = 0; i < file_1min.length; i++) {
            //        //                        var div_coordinate = document.createElement("div")
            //        //                        div_coordinate.setAttribute("id", "timeseries_" + (i + 1));
            //        //                        div_coordinate.setAttribute("style", "width:960px;height:220px;margin:20px 20px");
            //        //                        div_layout_show.appendChild(div_coordinate);
            //        //                        var file_name = file_1min[i];
            //        //                        var file_dir = "data/";
            //        //                        d3.csv((file_dir + file_name), typeEF, function(error, csv) {
            //        //                            timeseries('timeseries_' + m, m, csv, selectDate, 1, true, false);
            //        //                            m++;
            //        //                        })
            //        //                    }
            //        //                    break;
            //        //                default:
            //        //                    alert("请选择布局");
            //        //            }
            //        //        }
            //        var select_property = function() {
            //            var f = document.getElementById("file");
            //            var p = document.getElementById("select_p");
            //            var p = 0,
            //                q = 1;
            //            f.innerHTML = "";
            //            f.options[0] = new Option("请选择文件", "");
            //            for (var j in select_1_file) {
            //                f.options[q++] = new Option(select_1_file[p][1], p + "," + select_1_file[p][0]);
            //                p++;
            //            }
            //            f.onchange = function() {}
            //        }
            //
            //        function createDemos(f, s) {
            //            //日期控件
            //            var date = $("<div id='date' />").appendTo($("#dateSlider")); //渲染日期组件
            //            var dateTxt = $("<lable id='dateTxt' style='position:relative;top:30px;'/>&nbsp;&nbsp;&nbsp;").appendTo($("#dateSlider")); //渲染确定日期显示组件
            //            var dataTxt = $("<lable id='dataTxt' style='position:relative;top:30px;left:10px'/>").appendTo($("#dateSlider")); //渲染确定日期显示组件
            //            var dateSilderObj = date.dateRangeSlider({
            //                arrows: false, //是否显示左右箭头
            //                bounds: {
            //                    min: new Date(f),
            //                    max: new Date(s)
            //                }, //最大 最少日期
            //                defaultValues: {
            //                    min: new Date(f),
            //                    max: new Date(s)
            //                } //默认选中区域
            //
            //                ,
            //                scales: [{
            //                    first: function(value) {
            //                        return value;
            //                    },
            //                    end: function(value) {
            //                        return value;
            //                    },
            //                    next: function(val) {
            //                        var next = new Date(val);
            //                        return new Date(next.setMonth(next.getMonth() + 1));
            //                    },
            //                    label: function(val) {
            //                        return Months[val.getMonth()];
            //                    },
            //                    format: function(tickContainer, tickStart, tickEnd) {
            //                        tickContainer.addClass("myCustomClass");
            //                    }
            //                }]
            //            });
            //            //重新赋值（整个时间轴）
            //            dateSilderObj.dateRangeSlider("bounds", new Date(f), new Date(s));
            //            //重新赋值（选中区域）
            //            dateSilderObj.dateRangeSlider("values", new Date(f), new Date(s));
            //            //拖动完毕后的事件
            //            dateSilderObj.bind("valuesChanged", function(e, data) {
            //                var val = data.values;
            //                var stime = val.min.getFullYear() + "-" + (val.min.getMonth() + 1) + "-" + val.min.getDate() + " " + val.min.getHours() + ":" + val.min.getMinutes() + ":" + val.min.getSeconds();
            //                var etime = val.max.getFullYear() + "-" + (val.max.getMonth() + 1) + "-" + val.max.getDate() + " " + val.max.getHours() + ":" + val.max.getMinutes() + ":" + val.max.getSeconds();
            //                selectS = stime;
            //                selectE = etime;
            //                num = new Array();
            //                data_auto(stime, etime);
            //                dateTxt.text("起止时间：" + stime + " 至 " + etime);
            //            });
            //        }
            //
            function loadAll() {
                //            document.getElementById("dateSlider").innerHTML = "";
                document.getElementById("calendar").innerHTML = "";
                $.ajax({
                    url: '/dateRange',
                    type: 'GET',
                    success: function(arg) {
                        var date_obj = arg[0];
                        var various_obj = arg[1];
                        //                    createDemos(date_obj[0], date_obj[1]);
                        var select_obj = d3.select('#selectMap');
                        select_obj.innerHTML = "";
                        var options = select_obj.selectAll('option').data(various_obj);
                        var index = 0;
                        options.enter()
                            .append("option")
                            .attr("value", function(d, i) {
                                if (d == "MW") index = i;
                                return d;
                            })
                            .text(function(d) {
                                return d;
                            });
                        //                    console.log(index);
                        document.getElementById("selectMap").options[index].selected = true; 
                        init();
                    },
                    error: function() {
                        console.log('失败');
                    }
                });
            };

            function reload() {
                init();
                if (selectS != "" && selectE != "") {
                    switch (draw_flag) {
                        case 0:
                            draw_org();
                            break;
                        case 1:
                            drawAllDemo_auto();
                            break;
                        case 2:
                            drawAllSeg_auto();
                            break;
                    }
                } else
                    alert('选择时间窗');
            }

            function draw_select(d) {
                init();
                switch (d) {
                    case 0:
                        draw_org();
                        break;
                    case 1:
                        if (draw_flag == 0)
                            alert('请先选取工况划分参数！');
                        else
                            drawAllDemo_auto();
                        break;
                    case 2:
                        if (draw_flag < 2)
                            alert('请先选取工况划分和参数划分参数！');
                        else
                            drawAllSeg_auto();
                        break;
                }
            }
            //
            //        function brush_clear() {
            //            for (var i in brush_obj) {
            //                for (var j in brush_obj[i][2]) {
            //                    brush_obj[i][2] = [0, 0];
            //                }
            //            }
            //            for (var i in line_obj) {
            //                line_obj[i] = [0, 0];
            //            }
            //        }
            //
            //        function type(d, i) {
            //            d.date = parseDate.parse(d.date);
            //            //            console.log(d.date)
            //            d.keyDate = d.date.getFullYear() + "-" + ((d.date.getMonth() + 1) < 10 ? "0" : "") + (d.date.getMonth() + 1) + "-" + (d.date.getDate() < 10 ? "0" : "") + d.date.getDate();
            //            d.index = ++i;
            //            d.MW = parseInt(+d.MW); //发电功率
            //            d.MWD2 = parseInt(+d.MWD2); //负荷功率
            //            d.MSP = parseInt(+d.MSP); //主蒸汽压力
            //            d.MSPS = parseInt(+d.MSPS); //主蒸汽压力设定值
            //            d.THRTEMP = parseInt(+d.THRTEMP); //主蒸汽温度
            //            return d;
            //        }
            //
            //        function typeEF(d, i) {
            //            d.date = parseDate.parse(d.date);
            //            return d;
            //        }
        </script>
</body>

</html>